<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SM10 매매 계산기</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
        }
        
        .input-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .input-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #495057;
            font-size: 0.9em;
        }
        
        input, select {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .button-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn {
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-calculate {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-calculate:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-add {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }
        
        .btn-reset {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
        }
        
        .btn-reset:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(108, 117, 125, 0.3);
        }
        
        .results-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .result-box {
            background: white;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }
        
        .result-box h3 {
            color: #495057;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .buy-box {
            border-left: 4px solid #dc3545;
        }
        
        .sell-box {
            border-left: 4px solid #28a745;
        }
        
        .price-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .price-label {
            font-weight: 600;
            color: #495057;
        }
        
        .price-value {
            font-weight: 700;
            font-size: 1.1em;
        }
        
        .buy-price {
            color: #dc3545;
        }
        
        .sell-price {
            color: #28a745;
        }
        
        .info-box {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            margin-bottom: 20px;
        }
        
        .info-box p {
            color: #495057;
            line-height: 1.6;
            margin: 5px 0;
        }
        
        .stock-lists-container {
            margin-top: 40px;
        }
        
        .stock-lists-container h2 {
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .trading-criteria-top {
            background: #e7f3ff;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .trading-criteria-top p {
            color: #495057;
            font-size: 0.95em;
            font-weight: 500;
            text-align: center;
            margin: 0;
            line-height: 1.6;
        }
        
        .stock-lists {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .stock-list-box {
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }
        
        .stock-list-box.type-세력주 {
            background: #fff5f5;
            border-color: #ffc9c9;
        }
        
        .stock-list-box.type-반수급주 {
            background: #f0f9ff;
            border-color: #bae6fd;
        }
        
        .stock-list-box.type-초대형주 {
            background: #f0fdf4;
            border-color: #bbf7d0;
        }
        
        .stock-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .stock-list-box h4 {
            color: #667eea;
            font-size: 1.2em;
            margin: 0;
        }
        
        .bounce-info {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .bounce-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
            display: inline-block;
        }
        
        .bounce-standard {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .bounce-accepted {
            background: #fef3c7;
            color: #92400e;
        }
        
        .bounce-double {
            background: #fecaca;
            color: #991b1b;
        }
        
        .stock-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .stock-table thead {
            background: #f8f9fa;
        }
        
        .stock-table th {
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 0.85em;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }
        
        .stock-table th.section-header {
            background: #e9ecef;
            font-weight: 700;
            font-size: 0.9em;
            padding: 10px;
            border-bottom: 3px solid #adb5bd;
        }
        
        .stock-table th.bounce-section {
            background: #d1f4e0;
            color: #0d6832;
        }
        
        .stock-table th.buy-section {
            background: #f8d7da;
            color: #721c24;
        }
        
        .stock-table th.sell-section {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .stock-table th.stock-name-col {
            text-align: left;
            padding-left: 15px;
        }
        
        .stock-table td {
            padding: 12px 8px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9em;
        }
        
        .stock-table td.stock-name-cell {
            text-align: left;
            padding-left: 15px;
            font-weight: 600;
            color: #495057;
        }
        
        .stock-table td.buy-cell {
            color: #dc3545;
            font-weight: 600;
        }
        
        .stock-table td.sell-cell {
            color: #0d6efd;
            font-weight: 600;
        }
        
        .stock-table td.double-bottom-cell {
            color: #28a745;
            font-weight: 700;
        }
        
        .stock-table td.bounce-rate-cell {
            color: #495057;
            font-weight: 600;
        }
        
        .stock-table td.action-cell {
            padding: 8px;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 5px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-delete:hover {
            background: #c82333;
        }
        
        .stock-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .stock-table tbody tr[draggable="true"] {
            user-select: none;
        }
        
        .stock-table tbody tr.dragging {
            opacity: 0.5;
        }
        
        .empty-list {
            text-align: center;
            color: #6c757d;
            padding: 30px;
            font-style: italic;
        }
        
        .btn-google {
            background: #4285f4;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-google:hover {
            background: #357ae8;
            transform: translateY(-1px);
        }
        
        .btn-google:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .btn-backup {
            background: #10b981;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-backup:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-1px);
        }
        
        .btn-backup:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .btn-load {
            background: #f59e0b;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-load:hover:not(:disabled) {
            background: #d97706;
            transform: translateY(-1px);
        }
        
        .btn-load:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .sync-status.disconnected {
            background: #fee;
            color: #c33;
        }
        
        .sync-status.connected {
            background: #efe;
            color: #3c3;
        }
        
        .sync-status.syncing {
            background: #ffc;
            color: #cc6;
        }
        
        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }
        
        @media (max-width: 768px) {
            .results-section {
                grid-template-columns: 1fr;
            }
            
            .input-row {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                grid-template-columns: 1fr;
            }
            
            .stock-lists {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h1 style="margin: 0;">📊 SM10 매매 계산기</h1>
            <div style="display: flex; align-items: center; gap: 15px;">
                <div id="syncStatusContainer" style="display: flex; align-items: center; gap: 10px;">
                    <div id="syncStatus" class="sync-status disconnected">
                        <span class="sync-dot"></span>
                        <span id="statusText">연결 안됨</span>
                    </div>
                    <div id="lastSyncTime" style="font-size: 0.85em; color: #6c757d;"></div>
                </div>
                <button id="backupBtn" class="btn-backup" onclick="manualBackup()" disabled>
                    <span>💾</span>
                    <span>백업</span>
                </button>
                <button id="loadBtn" class="btn-load" onclick="manualLoad()" disabled>
                    <span>📥</span>
                    <span>로드</span>
                </button>
                <button id="googleBtn" class="btn-google" onclick="handleAuthClick()">
                    <span>🔐</span>
                    <span id="googleBtnText">구글 로그인</span>
                </button>
            </div>
        </div>
        
        <div class="input-section">
            <h3 style="color: #667eea; margin-bottom: 20px; font-size: 1.3em;">📝 종목 정보 입력</h3>
            <div class="input-row">
                <div class="input-group">
                    <label for="stockType">차트 구분</label>
                    <select id="stockType">
                        <option value="세력주">세력주</option>
                        <option value="반수급주">반수급주</option>
                        <option value="초대형주">초대형주</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="stockName">종목명</label>
                    <input type="text" id="stockName" placeholder="">
                </div>
            </div>
            
            <div class="input-row">
                <div class="input-group">
                    <label for="highPrice">기준고가 (원)</label>
                    <input type="text" id="highPrice" placeholder="">
                </div>
                
                <div class="input-group">
                    <label for="lowPrice">기준저가 (원)</label>
                    <input type="text" id="lowPrice" placeholder="">
                </div>
                
                <div class="input-group">
                    <label for="adjustedLow">수정저가 (원)</label>
                    <input type="text" id="adjustedLow" placeholder="선택사항">
                </div>
                
                <div class="input-group">
                    <label for="bouncePrice">반등저가 (원)</label>
                    <input type="text" id="bouncePrice" placeholder="선택사항">
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn btn-calculate" onclick="calculate()">💰 계산하기</button>
                <button class="btn btn-add" onclick="addToList()">➕ 리스트 추가</button>
                <button class="btn btn-reset" onclick="resetInput()">🔄 입력 초기화</button>
            </div>
        </div>
        
        <div class="info-box" id="infoBox" style="display:none;">
            <p><strong>📌 반등 기준:</strong> <span id="bounceInfo"></span></p>
        </div>
        
        <div class="results-section" id="results" style="display:none;">
            <div class="result-box buy-box">
                <h3>🔴 매수 타점</h3>
                <div id="buyPrices"></div>
            </div>
            
            <div class="result-box sell-box">
                <h3>🟢 매도 타점</h3>
                <div id="sellPrices"></div>
            </div>
        </div>
        
        <div class="stock-lists-container">
            <h2>📋 종목 리스트</h2>
            <div class="trading-criteria-top">
                <p>📌 매매 기준: 3개월 신고가 | 당일거래대금 500억 이상 (횡보구간 300억) | 프로그램순매도가 거래대금 대비 10% 이상인지 체크</p>
            </div>
            <div class="stock-lists">
                <div class="stock-list-box type-세력주">
                    <div class="stock-list-header">
                        <h4>⚡ 세력주 종목리스트</h4>
                        <div class="bounce-info">
                            <span class="bounce-badge bounce-standard">기준반등 4%</span>
                            <span class="bounce-badge bounce-accepted">인정반등 3%</span>
                            <span class="bounce-badge bounce-double">쌍바닥반등 7%</span>
                        </div>
                    </div>
                    <div id="list-세력주" class="stock-list-content">
                        <div class="empty-list">등록된 종목이 없습니다</div>
                    </div>
                </div>
                
                <div class="stock-list-box type-반수급주">
                    <div class="stock-list-header">
                        <h4>💎 반수급주 종목리스트</h4>
                        <div class="bounce-info">
                            <span class="bounce-badge bounce-standard">기준반등 3.5%</span>
                            <span class="bounce-badge bounce-accepted">인정반등 3%</span>
                            <span class="bounce-badge bounce-double">쌍바닥반등 6%</span>
                        </div>
                    </div>
                    <div id="list-반수급주" class="stock-list-content">
                        <div class="empty-list">등록된 종목이 없습니다</div>
                    </div>
                </div>
                
                <div class="stock-list-box type-초대형주">
                    <div class="stock-list-header">
                        <h4>🏢 초대형주 종목리스트</h4>
                        <div class="bounce-info">
                            <span class="bounce-badge bounce-standard">기준반등 3%</span>
                            <span class="bounce-badge bounce-accepted">인정반등 2.5%</span>
                            <span class="bounce-badge bounce-double">쌍바닥반등 4%</span>
                        </div>
                    </div>
                    <div id="list-초대형주" class="stock-list-content">
                        <div class="empty-list">등록된 종목이 없습니다</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== 구글 API 설정 ==========
        const CLIENT_ID = '574140412573-n0jau2i3uph1v5p3hi9v004m44bnopq8.apps.googleusercontent.com';
        const API_KEY = '';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const FILE_NAME = 'sm10_stocks_data.json';
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let isSignedIn = false;
        let driveFileId = null;
        let tokenRefreshTimer = null; // 토큰 자동 갱신 타이머
        
        // ========== 종목 리스트 저장용 ==========
        let stockLists = {
            '세력주': [],
            '반수급주': [],
            '초대형주': []
        };
        
        let currentSelectedIndex = -1;
        let currentSelectedType = '';
        
        // ========== 구글 API 초기화 ==========
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // 나중에 설정
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('googleBtn').disabled = false;
            }
        }

        function handleAuthClick() {
            if (isSignedIn) {
                handleSignoutClick();
            } else {
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) {
                        throw (resp);
                    }
                    
                    // 토큰을 localStorage에 저장
                    localStorage.setItem('google_access_token', resp.access_token);
                    if (resp.expires_in) {
                        const expiryTime = Date.now() + (resp.expires_in * 1000);
                        localStorage.setItem('google_token_expiry', expiryTime.toString());
                        
                        // 토큰 자동 갱신 타이머 설정 (만료 5분 전에 갱신)
                        setupTokenRefresh(resp.expires_in);
                    }
                    
                    isSignedIn = true;
                    updateSyncStatus('connected', '연결됨');
                    document.getElementById('googleBtnText').textContent = '로그아웃';
                    document.getElementById('backupBtn').disabled = false;
                    document.getElementById('loadBtn').disabled = false;
                    await loadFromGoogleDrive();
                };

                if (gapi.client.getToken() === null) {
                    tokenClient.requestAccessToken({prompt: 'consent'});
                } else {
                    tokenClient.requestAccessToken({prompt: ''});
                }
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
            }
            
            // 토큰 갱신 타이머 정리
            if (tokenRefreshTimer) {
                clearTimeout(tokenRefreshTimer);
                tokenRefreshTimer = null;
            }
            
            // localStorage에서 토큰 삭제
            localStorage.removeItem('google_access_token');
            localStorage.removeItem('google_token_expiry');
            
            isSignedIn = false;
            updateSyncStatus('disconnected', '연결 안됨');
            document.getElementById('googleBtnText').textContent = '구글 로그인';
            document.getElementById('lastSyncTime').textContent = '';
            document.getElementById('backupBtn').disabled = true;
            document.getElementById('loadBtn').disabled = true;
        }

        // ========== 저장된 토큰으로 로그인 복원 ==========
        async function restoreLoginState() {
            const savedToken = localStorage.getItem('google_access_token');
            const tokenExpiry = localStorage.getItem('google_token_expiry');
            
            if (savedToken && tokenExpiry) {
                // 토큰이 만료되지 않았는지 확인
                if (Date.now() < parseInt(tokenExpiry)) {
                    // 토큰을 gapi 클라이언트에 설정
                    gapi.client.setToken({
                        access_token: savedToken
                    });
                    
                    isSignedIn = true;
                    updateSyncStatus('connected', '연결됨');
                    document.getElementById('googleBtnText').textContent = '로그아웃';
                    document.getElementById('backupBtn').disabled = false;
                    document.getElementById('loadBtn').disabled = false;
                    
                    // 남은 시간 계산하여 토큰 자동 갱신 타이머 설정
                    const remainingSeconds = Math.floor((parseInt(tokenExpiry) - Date.now()) / 1000);
                    setupTokenRefresh(remainingSeconds);
                    
                    // 드라이브에서 데이터 불러오기
                    await loadFromGoogleDrive();
                } else {
                    // 토큰이 만료되었으면 삭제
                    localStorage.removeItem('google_access_token');
                    localStorage.removeItem('google_token_expiry');
                }
            }
        }

        // ========== 토큰 자동 갱신 설정 ==========
        function setupTokenRefresh(expiresInSeconds) {
            // 기존 타이머가 있으면 제거
            if (tokenRefreshTimer) {
                clearTimeout(tokenRefreshTimer);
            }
            
            // 만료 5분 전에 갱신 (최소 1분 전)
            const refreshTime = Math.max((expiresInSeconds - 300) * 1000, 60 * 1000);
            
            tokenRefreshTimer = setTimeout(async () => {
                if (isSignedIn && tokenClient) {
                    try {
                        // 팝업 없이 자동 갱신 시도
                        tokenClient.callback = async (resp) => {
                            if (resp.error === undefined) {
                                // 토큰을 localStorage에 저장
                                localStorage.setItem('google_access_token', resp.access_token);
                                if (resp.expires_in) {
                                    const expiryTime = Date.now() + (resp.expires_in * 1000);
                                    localStorage.setItem('google_token_expiry', expiryTime.toString());
                                    
                                    // 다시 타이머 설정
                                    setupTokenRefresh(resp.expires_in);
                                }
                                
                                gapi.client.setToken({
                                    access_token: resp.access_token
                                });
                                
                                console.log('토큰이 자동으로 갱신되었습니다.');
                            }
                        };
                        
                        tokenClient.requestAccessToken({prompt: ''});
                    } catch (err) {
                        console.error('토큰 자동 갱신 실패:', err);
                    }
                }
            }, refreshTime);
        }

        // ========== 동기화 상태 표시 ==========
        function updateSyncStatus(status, text) {
            const statusEl = document.getElementById('syncStatus');
            const textEl = document.getElementById('statusText');
            statusEl.className = `sync-status ${status}`;
            textEl.textContent = text;
        }

        function updateLastSyncTime() {
            const now = new Date();
            const timeStr = now.toLocaleString('ko-KR', { 
                month: '2-digit', 
                day: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            document.getElementById('lastSyncTime').textContent = `마지막 동기화: ${timeStr}`;
        }

        // ========== 구글 드라이브 파일 찾기 ==========
        async function findDriveFile() {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${FILE_NAME}' and trashed=false`,
                    spaces: 'drive',
                    fields: 'files(id, name)',
                });
                const files = response.result.files;
                if (files && files.length > 0) {
                    return files[0].id;
                }
                return null;
            } catch (err) {
                console.error('파일 검색 오류:', err);
                return null;
            }
        }

        // ========== 구글 드라이브에서 불러오기 ==========
        async function loadFromGoogleDrive() {
            if (!isSignedIn) return;
            
            updateSyncStatus('syncing', '불러오는 중...');
            
            try {
                driveFileId = await findDriveFile();
                
                if (driveFileId) {
                    const response = await gapi.client.drive.files.get({
                        fileId: driveFileId,
                        alt: 'media',
                    });
                    
                    stockLists = JSON.parse(response.body);
                    localStorage.setItem('sm10_stock_lists', JSON.stringify(stockLists));
                    renderAllLists();
                    updateSyncStatus('connected', '연결됨');
                    updateLastSyncTime();
                } else {
                    updateSyncStatus('connected', '연결됨 (파일 없음)');
                }
            } catch (err) {
                console.error('불러오기 오류:', err);
                updateSyncStatus('connected', '연결됨');
            }
        }

        // ========== 구글 드라이브에 저장 ==========
        async function saveToGoogleDrive() {
            if (!isSignedIn) return;
            
            updateSyncStatus('syncing', '저장 중...');
            
            try {
                const data = JSON.stringify(stockLists, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                
                if (driveFileId) {
                    // 파일 업데이트
                    const metadata = {
                        name: FILE_NAME,
                        mimeType: 'application/json',
                    };
                    
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', blob);
                    
                    await fetch(`https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=multipart`, {
                        method: 'PATCH',
                        headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
                        body: form,
                    });
                } else {
                    // 새 파일 생성
                    const metadata = {
                        name: FILE_NAME,
                        mimeType: 'application/json',
                    };
                    
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', blob);
                    
                    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
                        body: form,
                    });
                    
                    const result = await response.json();
                    driveFileId = result.id;
                }
                
                updateSyncStatus('connected', '연결됨');
                updateLastSyncTime();
            } catch (err) {
                console.error('저장 오류:', err);
                updateSyncStatus('connected', '연결됨 (저장 실패)');
            }
        }

        // ========== 수동 백업 ==========
        async function manualBackup() {
            if (!isSignedIn) {
                alert('구글 로그인이 필요합니다.');
                return;
            }
            
            if (confirm('현재 데이터를 구글 드라이브에 백업하시겠습니까?')) {
                await saveToGoogleDrive();
                alert('백업이 완료되었습니다!');
            }
        }

        // ========== 수동 불러오기 ==========
        async function manualLoad() {
            if (!isSignedIn) {
                alert('구글 로그인이 필요합니다.');
                return;
            }
            
            if (confirm('구글 드라이브에서 데이터를 로드하시겠습니까?\n현재 데이터는 덮어씌워집니다.')) {
                await loadFromGoogleDrive();
                alert('데이터를 로드했습니다!');
            }
        }

        // ========== 로컬스토리지에서 불러오기 ==========
        window.onload = async function() {
            const saved = localStorage.getItem('sm10_stock_lists');
            if (saved) {
                stockLists = JSON.parse(saved);
                
                // 기존 데이터에 기준반등 값이 없으면 계산
                ['세력주', '반수급주', '초대형주'].forEach(type => {
                    stockLists[type].forEach(item => {
                        if (!item.bounceRate && item.highPrice && item.lowPrice) {
                            item.bounceRate = ((item.highPrice - item.lowPrice) / item.lowPrice * 100).toFixed(2);
                        }
                        // 쌍바닥타점 재계산 (기준이 변경되었을 수 있으므로)
                        if (item.bounceRate && item.lowPrice) {
                            let doubleBounceThreshold, doubleBottomRate;
                            
                            if (type === '세력주') {
                                doubleBounceThreshold = 7.0;
                                doubleBottomRate = 0.01;
                            } else if (type === '반수급주') {
                                doubleBounceThreshold = 6.0;
                                doubleBottomRate = 0.01;
                            } else {
                                doubleBounceThreshold = 4.0;
                                doubleBottomRate = 0.005;
                            }
                            
                            if (parseFloat(item.bounceRate) >= doubleBounceThreshold) {
                                const calculatedPrice = item.lowPrice * (1 + doubleBottomRate);
                                item.doubleBottomPrice = adjustToTickPrice(calculatedPrice, false);
                            } else {
                                item.doubleBottomPrice = null;
                            }
                        }
                    });
                });
                
                // 업데이트된 데이터 저장
                localStorage.setItem('sm10_stock_lists', JSON.stringify(stockLists));
                
                renderAllLists();
            }
            
            // 가격 입력 필드에 쉼표 포맷팅 이벤트 추가
            ['highPrice', 'lowPrice', 'adjustedLow', 'bouncePrice'].forEach(id => {
                const input = document.getElementById(id);
                input.addEventListener('input', formatInputPrice);
                input.addEventListener('blur', formatInputPrice);
            });
            
            // 구글 API 초기화
            gapiLoaded();
            gisLoaded();
            
            // 구글 API 초기화 대기 후 로그인 상태 복원
            const waitForInit = setInterval(async () => {
                if (gapiInited && gisInited) {
                    clearInterval(waitForInit);
                    await restoreLoginState();
                }
            }, 100);
        };
        
        // 가격 입력 필드 쉼표 포맷팅
        function formatInputPrice(e) {
            let value = e.target.value.replace(/,/g, '');
            if (value && !isNaN(value)) {
                e.target.value = parseInt(value).toLocaleString('ko-KR');
            }
        }
        
        // 쉼표 제거하고 숫자로 변환
        function parseFormattedPrice(value) {
            return parseFloat(value.replace(/,/g, ''));
        }
        
        // 호가 단위 계산 함수
        function getPriceUnit(price) {
            if (price < 1000) return 1;
            else if (price < 5000) return 5;
            else if (price < 10000) return 10;
            else if (price < 50000) return 50;
            else if (price < 100000) return 100;
            else if (price < 500000) return 500;
            else return 1000;
        }
        
        // 호가에 맞춰 조정하는 함수
        function adjustToTickPrice(price, roundUp) {
            const unit = getPriceUnit(price);
            if (roundUp) {
                // 매수 타점: 계산값보다 큰 가장 가까운 호가
                return Math.ceil(price / unit) * unit;
            } else {
                // 매도 타점: 계산값보다 작은 가장 가까운 호가
                return Math.floor(price / unit) * unit;
            }
        }
        
        // 가격 포맷팅
        function formatPrice(price) {
            return price.toLocaleString('ko-KR');
        }
        
        // 계산 함수
        function calculate() {
            const stockType = document.getElementById('stockType').value;
            const stockName = document.getElementById('stockName').value;
            const highPrice = parseFormattedPrice(document.getElementById('highPrice').value);
            const lowPrice = parseFormattedPrice(document.getElementById('lowPrice').value);
            const adjustedLow = parseFormattedPrice(document.getElementById('adjustedLow').value);
            const bouncePrice = parseFormattedPrice(document.getElementById('bouncePrice').value);
            
            // 유효성 검사
            if (!stockName || !lowPrice) {
                alert('종목명과 기준저가는 필수 입력값입니다.');
                return;
            }
            
            // 매수 기준가 결정 (수정저가가 있으면 수정저가, 없으면 기준저가)
            const buyBasePrice = adjustedLow || lowPrice;
            
            // 타입별 매수/매도 비율 설정
            let buyRatios, sellRatios, bounceInfo;
            
            if (stockType === '세력주') {
                buyRatios = [0.03, 0.06, 0.09, 0.12];
                sellRatios = [0.03, 0.04, 0.05, 0.06];
                bounceInfo = '기준반등 4% | 인정반등 3% | 쌍바닥반등 7%';
            } else if (stockType === '반수급주') {
                buyRatios = [0.025, 0.05, 0.075, 0.10];
                sellRatios = [0.025, 0.035, 0.045, 0.055];
                bounceInfo = '기준반등 3.5% | 인정반등 3% | 쌍바닥반등 6%';
            } else { // 초대형주
                buyRatios = [0.02, 0.04, 0.06, 0.08];
                sellRatios = [0.02, 0.03, 0.04, 0.05];
                bounceInfo = '기준반등 3% | 인정반등 2.5% | 쌍바닥반등 4%';
            }
            
            // 기준반등률 계산 및 표시
            if (highPrice && lowPrice) {
                const bounceRate = ((highPrice - lowPrice) / lowPrice * 100).toFixed(2);
                bounceInfo += ` | 현재 기준반등: ${bounceRate}%`;
            }
            
            // 매수 타점 계산 (하락)
            let buyPricesHTML = '';
            buyRatios.forEach((ratio) => {
                const calculatedPrice = buyBasePrice * (1 - ratio);
                const adjustedPrice = adjustToTickPrice(calculatedPrice, true);
                const percentage = (ratio * 100).toFixed(1);
                
                buyPricesHTML += `
                    <div class="price-item">
                        <span class="price-label">${percentage}% 매수</span>
                        <span class="price-value buy-price">${formatPrice(adjustedPrice)}원</span>
                    </div>
                `;
            });
            
            // 매도 타점 계산 (상승)
            let sellPricesHTML = '';
            if (bouncePrice) {
                sellRatios.forEach((ratio) => {
                    const calculatedPrice = bouncePrice * (1 + ratio);
                    const adjustedPrice = adjustToTickPrice(calculatedPrice, false);
                    const percentage = (ratio * 100).toFixed(1);
                    
                    sellPricesHTML += `
                        <div class="price-item">
                            <span class="price-label">${percentage}% 매도</span>
                            <span class="price-value sell-price">${formatPrice(adjustedPrice)}원</span>
                        </div>
                    `;
                });
            } else {
                sellPricesHTML = '<p style="text-align:center; color:#6c757d; padding:20px;">반등저가를 입력하면<br>매도 타점이 표시됩니다.</p>';
            }
            
            // 결과 표시
            document.getElementById('buyPrices').innerHTML = buyPricesHTML;
            document.getElementById('sellPrices').innerHTML = sellPricesHTML;
            document.getElementById('bounceInfo').textContent = bounceInfo;
            document.getElementById('infoBox').style.display = 'block';
            document.getElementById('results').style.display = 'grid';
        }
        
        // 리스트에 추가
        function addToList() {
            const stockType = document.getElementById('stockType').value;
            const stockName = document.getElementById('stockName').value;
            const highPrice = parseFormattedPrice(document.getElementById('highPrice').value);
            const lowPrice = parseFormattedPrice(document.getElementById('lowPrice').value);
            const adjustedLow = parseFormattedPrice(document.getElementById('adjustedLow').value);
            const bouncePrice = parseFormattedPrice(document.getElementById('bouncePrice').value);
            
            // 유효성 검사
            if (!stockName || !lowPrice || !highPrice) {
                alert('종목명, 기준고가, 기준저가는 필수 입력값입니다.');
                return;
            }
            
            // 기준반등률 계산 (기준고가 대비 기준저가의 상승률)
            const bounceRate = ((highPrice - lowPrice) / lowPrice * 100).toFixed(2);
            
            // 매수 기준가 결정
            const buyBasePrice = adjustedLow || lowPrice;
            
            // 타입별 비율 설정
            let buyRatios, sellRatios, doubleBounceThreshold, doubleBottomRate;
            
            if (stockType === '세력주') {
                buyRatios = [0.03, 0.06, 0.09, 0.12];
                sellRatios = [0.03, 0.04, 0.05, 0.06];
                doubleBounceThreshold = 7.0;
                doubleBottomRate = 0.01; // 1%
            } else if (stockType === '반수급주') {
                buyRatios = [0.025, 0.05, 0.075, 0.10];
                sellRatios = [0.025, 0.035, 0.045, 0.055];
                doubleBounceThreshold = 6.0;
                doubleBottomRate = 0.01; // 1%
            } else { // 초대형주
                buyRatios = [0.02, 0.04, 0.06, 0.08];
                sellRatios = [0.02, 0.03, 0.04, 0.05];
                doubleBounceThreshold = 4.0;
                doubleBottomRate = 0.005; // 0.5%
            }
            
            // 매수/매도 가격 계산
            const buyPrices = buyRatios.map(ratio => {
                const calculatedPrice = buyBasePrice * (1 - ratio);
                return adjustToTickPrice(calculatedPrice, true);
            });
            
            const sellPrices = bouncePrice ? sellRatios.map(ratio => {
                const calculatedPrice = bouncePrice * (1 + ratio);
                return adjustToTickPrice(calculatedPrice, false);
            }) : [];
            
            // 쌍바닥타점 계산 (기준반등률이 임계값 이상일 때만)
            let doubleBottomPrice = null;
            if (parseFloat(bounceRate) >= doubleBounceThreshold) {
                const calculatedPrice = lowPrice * (1 + doubleBottomRate);
                doubleBottomPrice = adjustToTickPrice(calculatedPrice, false);
            }
            
            // 종목 객체 생성
            const stockItem = {
                name: stockName,
                highPrice: highPrice,
                lowPrice: lowPrice,
                adjustedLow: adjustedLow,
                bouncePrice: bouncePrice,
                bounceRate: bounceRate,
                buyPrices: buyPrices,
                sellPrices: sellPrices,
                doubleBottomPrice: doubleBottomPrice,
                type: stockType,
                timestamp: Date.now()
            };
            
            // 기존 종목 업데이트 또는 새로 추가
            if (currentSelectedIndex !== -1 && currentSelectedType === stockType) {
                // 기존 종목 업데이트
                stockLists[stockType][currentSelectedIndex] = stockItem;
                alert(`${stockName} 입력값이 업데이트 되었습니다.`);
                currentSelectedIndex = -1;
                currentSelectedType = '';
            } else {
                // 동일한 종목명이 이미 있는지 확인
                const existingIndex = stockLists[stockType].findIndex(item => item.name === stockName);
                
                if (existingIndex !== -1) {
                    // 이미 존재하는 종목이면 업데이트
                    if (confirm(`"${stockName}"은(는) 이미 ${stockType} 리스트에 있습니다.\n기존 데이터를 업데이트하시겠습니까?`)) {
                        stockLists[stockType][existingIndex] = stockItem;
                        alert(`${stockName} 입력값이 업데이트 되었습니다.`);
                    } else {
                        return; // 취소하면 함수 종료
                    }
                } else {
                    // 새 종목 추가
                    stockLists[stockType].push(stockItem);
                    alert(`${stockName}이(가) 추가되었습니다.`);
                }
                currentSelectedIndex = -1;
                currentSelectedType = '';
            }
            
            // 로컬스토리지에 저장
            localStorage.setItem('sm10_stock_lists', JSON.stringify(stockLists));
            
            // 구글 드라이브에 저장
            saveToGoogleDrive();
            
            // 리스트 렌더링
            renderList(stockType);
        }
        
        // 리스트 렌더링
        function renderList(stockType) {
            const container = document.getElementById(`list-${stockType}`);
            const items = stockLists[stockType];
            
            if (items.length === 0) {
                container.innerHTML = '<div class="empty-list">등록된 종목이 없습니다</div>';
                return;
            }
            
            // 비율 라벨 가져오기
            const buyLabels = getRatioLabels(stockType, 'buy');
            const sellLabels = getRatioLabels(stockType, 'sell');
            
            let html = `
                <table class="stock-table">
                    <thead>
                        <tr>
                            <th class="stock-name-col" rowspan="2">종목명</th>
                            <th class="section-header bounce-section" colspan="2">기준반등 & 쌍바닥</th>
                            <th class="section-header buy-section" colspan="${buyLabels.length}">매수 타점</th>
                            <th class="section-header sell-section" colspan="${sellLabels.length}">매도 타점</th>
                            <th rowspan="2">관리</th>
                        </tr>
                        <tr>
                            <th>기준반등</th>
                            <th>쌍바닥타점</th>
                            ${buyLabels.map(label => `<th>${label}</th>`).join('')}
                            ${sellLabels.map(label => `<th>${label}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody id="sortable-${stockType}">
            `;
            
            items.forEach((item, index) => {
                html += `
                    <tr draggable="true" data-index="${index}" onclick="fillInputs('${stockType}', ${index})" style="cursor: pointer;">
                        <td class="stock-name-cell">${item.name}</td>
                        <td class="bounce-rate-cell">${item.bounceRate}%</td>
                        <td class="double-bottom-cell">${item.doubleBottomPrice ? formatPrice(item.doubleBottomPrice) : '-'}</td>
                        ${item.buyPrices.map(price => 
                            `<td class="buy-cell">${formatPrice(price)}</td>`
                        ).join('')}
                        ${item.sellPrices.length > 0 ? 
                            item.sellPrices.map(price => 
                                `<td class="sell-cell">${formatPrice(price)}</td>`
                            ).join('') : 
                            sellLabels.map(() => '<td>-</td>').join('')
                        }
                        <td class="action-cell">
                            <button class="btn-delete" onclick="event.stopPropagation(); deleteFromList('${stockType}', ${index})">삭제</button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
            
            // 드래그 앤 드롭 이벤트 설정
            setupDragAndDrop(stockType);
        }
        
        // 비율 라벨 배열 가져오기
        function getRatioLabels(stockType, type) {
            const buyLabels = {
                '세력주': ['3%', '6%', '9%', '12%'],
                '반수급주': ['2.5%', '5%', '7.5%', '10%'],
                '초대형주': ['2%', '4%', '6%', '8%']
            };
            
            const sellLabels = {
                '세력주': ['3%', '4%', '5%', '6%'],
                '반수급주': ['2.5%', '3.5%', '4.5%', '5.5%'],
                '초대형주': ['2%', '3%', '4%', '5%']
            };
            
            return type === 'buy' ? buyLabels[stockType] : sellLabels[stockType];
        }
        
        // 모든 리스트 렌더링
        function renderAllLists() {
            ['세력주', '반수급주', '초대형주'].forEach(type => {
                renderList(type);
            });
        }
        
        // 리스트에서 삭제
        function deleteFromList(stockType, index) {
            if (confirm('이 종목을 리스트에서 삭제하시겠습니까?')) {
                stockLists[stockType].splice(index, 1);
                localStorage.setItem('sm10_stock_lists', JSON.stringify(stockLists));
                saveToGoogleDrive();
                renderList(stockType);
            }
        }
        
        // 입력 초기화
        function resetInput() {
            currentSelectedIndex = -1;
            currentSelectedType = '';
            document.getElementById('stockName').value = '';
            document.getElementById('highPrice').value = '';
            document.getElementById('lowPrice').value = '';
            document.getElementById('adjustedLow').value = '';
            document.getElementById('bouncePrice').value = '';
            document.getElementById('results').style.display = 'none';
            document.getElementById('infoBox').style.display = 'none';
        }
        
        // 엔터키로 계산 실행
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                calculate();
            }
        });
        
        // 드래그 앤 드롭 설정
        function setupDragAndDrop(stockType) {
            const tbody = document.getElementById(`sortable-${stockType}`);
            if (!tbody) return;
            
            let draggedRow = null;
            let draggedIndex = null;
            
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row) => {
                row.addEventListener('dragstart', function(e) {
                    draggedRow = this;
                    draggedIndex = parseInt(this.getAttribute('data-index'));
                    this.style.opacity = '0.5';
                });
                
                row.addEventListener('dragend', function(e) {
                    this.style.opacity = '1';
                });
                
                row.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(tbody, e.clientY);
                    if (afterElement == null) {
                        tbody.appendChild(draggedRow);
                    } else {
                        tbody.insertBefore(draggedRow, afterElement);
                    }
                });
                
                row.addEventListener('drop', function(e) {
                    e.preventDefault();
                    const dropIndex = parseInt(this.getAttribute('data-index'));
                    
                    // 배열 순서 변경
                    const [movedItem] = stockLists[stockType].splice(draggedIndex, 1);
                    const newIndex = Array.from(tbody.children).indexOf(draggedRow);
                    stockLists[stockType].splice(newIndex, 0, movedItem);
                    
                    // 로컬스토리지 저장
                    localStorage.setItem('sm10_stock_lists', JSON.stringify(stockLists));
                    
                    // 구글 드라이브에 저장
                    saveToGoogleDrive();
                    
                    // 리렌더링
                    renderList(stockType);
                });
            });
        }
        
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('tr:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        // 종목 클릭 시 입력 폼에 값 채우기
        function fillInputs(stockType, index) {
            const item = stockLists[stockType][index];
            
            // 현재 선택된 종목 인덱스와 타입 저장
            currentSelectedIndex = index;
            currentSelectedType = stockType;
            
            // 드롭다운 값 설정
            document.getElementById('stockType').value = stockType;
            
            // 입력 필드에 값 채우기
            document.getElementById('stockName').value = item.name;
            document.getElementById('highPrice').value = formatPrice(item.highPrice);
            document.getElementById('lowPrice').value = formatPrice(item.lowPrice);
            document.getElementById('adjustedLow').value = item.adjustedLow ? formatPrice(item.adjustedLow) : '';
            document.getElementById('bouncePrice').value = item.bouncePrice ? formatPrice(item.bouncePrice) : '';
            
            // 자동으로 계산 실행
            calculate();
            
            // 입력 영역으로 스크롤
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>
