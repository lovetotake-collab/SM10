<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SM10 ì§€ëŠ¥í˜• ë§¤ë§¤ v18 (ë§¤ìˆ˜ì¤€ë¹„ê°•ì¡°)</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Pretendard', 'Segoe UI', sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 20px; min-height: 100vh; color: #333; }
        .container { max-width: 1800px; margin: 0 auto; background: white; border-radius: 24px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        
        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        .header-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f1f5f9; padding-bottom: 20px; }
        h1 { color: #1e293b; font-size: 2.2em; font-weight: 800; display: flex; align-items: center; gap: 10px; }
        .status-bar { display: flex; gap: 10px; margin-top: 10px; }
        
        /* ì»¨íŠ¸ë¡¤ ë²„íŠ¼ */
        .top-controls { display: flex; gap: 10px; }
        .btn-ctrl { padding: 10px 18px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; color: white; transition: all 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 6px; }
        .btn-ctrl:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .btn-google { background: #4285f4; }
        .btn-backup { background: #10b981; }
        .btn-load { background: #f59e0b; }
        .btn-history { background: #6366f1; position: relative; }
        .noti-count { position: absolute; top: -5px; right: -5px; background: #dc2626; color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 10px; border: 2px solid white; display: none; }

        /* ë§¤ë§¤ ê¸°ì¤€ ë°°ë„ˆ */
        .trading-guide { background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 12px; padding: 15px; margin-bottom: 30px; text-align: center; color: #1e3a8a; font-weight: 600; font-size: 0.95em; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; gap: 10px; }
        .guide-icon { font-size: 1.2em; }

        /* ì…ë ¥ í¼ ì„¹ì…˜ */
        .input-section { background: #f8fafc; padding: 30px; border-radius: 20px; border: 1px solid #e2e8f0; margin-bottom: 30px; }
        .input-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .input-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-size: 0.9em; font-weight: 700; color: #64748b; margin-left: 4px; }
        input, select { padding: 12px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1em; transition: all 0.2s; background: white; }
        input:focus, select:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }
        .input-price { text-align: right; font-family: 'Roboto Mono', monospace; font-weight: 600; }
        .input-record-high input { border-color: #fecaca; background: #fff1f2; color: #dc2626; }

        /* ë©”ì¸ ë²„íŠ¼ ê·¸ë£¹ */
        .button-group { display: grid; grid-template-columns: 2fr 2fr 1fr; gap: 15px; margin-top: 25px; }
        .btn-main { padding: 16px; border: none; border-radius: 14px; font-size: 1.1em; font-weight: 800; cursor: pointer; color: white; transition: all 0.2s; }
        .btn-main:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .btn-calc { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); }
        .btn-add { background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }
        .btn-reset { background: #94a3b8; }

        /* ì£¼ì‹ ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸” */
        .stock-lists-container { display: flex; flex-direction: column; gap: 30px; }
        .stock-list-box { background: white; border-radius: 20px; overflow: hidden; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .list-header { padding: 15px 25px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
        .list-title { font-weight: 800; font-size: 1.2em; display: flex; align-items: center; gap: 10px; }
        
        /* ìœ í˜•ë³„ ê¸°ì¤€ ë°°ì§€ */
        .criteria-badges { display: flex; gap: 8px; }
        .cri-badge { padding: 6px 12px; border-radius: 8px; font-size: 0.85em; font-weight: 700; display: inline-flex; align-items: center; gap: 4px; }
        .cri-blue { background: #dbeafe; color: #1e40af; }
        .cri-yellow { background: #fef9c3; color: #854d0e; }
        .cri-red { background: #fee2e2; color: #991b1b; }

        .stock-table { width: 100%; border-collapse: collapse; text-align: center; table-layout: fixed; }
        .stock-table th { padding: 12px 5px; font-weight: 700; color: #64748b; font-size: 0.85em; background: #f1f5f9; white-space: nowrap; }
        .stock-table td { padding: 12px 5px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; font-size: 0.95em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .stock-table tr { transition: background 0.2s; cursor: pointer; }
        .stock-table tr:hover { background: #f8fafc; }

        /* [NEW] ë§¤ìˆ˜ ì¤€ë¹„ ê°•ì¡° ìŠ¤íƒ€ì¼ */
        .buy-ready { background-color: #ffe4e6 !important; box-shadow: inset 0 0 0 2px #fda4af; animation: pulse-bg 2s infinite; }
        @keyframes pulse-bg { 0% { background-color: #ffe4e6; } 50% { background-color: #fff1f2; } 100% { background-color: #ffe4e6; } }

        /* íƒ€ì  ìŠ¤íƒ€ì¼ */
        .th-buy { background: #eff6ff !important; color: #1e40af !important; }
        .th-sell { background: #fff1f2 !important; color: #991b1b !important; }
        .price-buy { color: #dc2626; font-weight: 600; letter-spacing: -0.5px; }
        .price-sell { color: #2563eb; font-weight: 600; letter-spacing: -0.5px; }
        .price-double { color: #7c3aed; font-weight: 700; background: #f3e8ff; padding: 2px 6px; border-radius: 4px; }

        /* ë±ƒì§€ */
        .badge-n { display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #dc2626; color: white; font-size: 10px; font-weight: 900; border-radius: 4px; margin-left: 4px; animation: pulse 2s infinite; }
        .badge-update { background: #059669; }
        .badge-w { background: #7c3aed; } /* ìŒë°”ë‹¥ W */
        
        .price-display { display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .price-current { font-weight: 800; font-size: 1.05em; color: #333; }
        .price-rate { font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 2px; }
        .up { color: #dc2626; }
        .down { color: #2563eb; }
        .flat { color: #333; }

        /* ê·¼ì ‘ë„ ë°•ìŠ¤ */
        .prox-box { padding: 3px 6px; border-radius: 6px; font-weight: 700; font-size: 0.9em; display: inline-block; width: 90%; }
        .prox-green { background: #dcfce7; color: #166534; border: 1px solid #86efac; box-shadow: 0 0 5px rgba(34, 197, 94, 0.2); }
        .prox-orange { background: #ffedd5; color: #9a3412; border: 1px solid #fdba74; box-shadow: 0 0 5px rgba(249, 115, 22, 0.2); }
        .prox-reached { background: #f1f5f9; color: #94a3b8; text-decoration: line-through; border: 1px solid #e2e8f0; }

        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .status-connected { background: #dcfce7; color: #15803d; }
        .status-disconnected { background: #fee2e2; color: #b91c1c; }
        
        .delete-btn { width: 24px; height: 24px; border-radius: 50%; border: none; background: #fee2e2; color: #ef4444; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .delete-btn:hover { background: #ef4444; color: white; transform: scale(1.1); }

        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.8; transform: scale(1.1); } 100% { opacity: 1; transform: scale(1); } }
        
        .toast { position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.85); color: white; padding: 16px 24px; border-radius: 12px; z-index: 9999; animation: slideIn 0.3s ease-out; backdrop-filter: blur(5px); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* ì•Œë¦¼ ë‚´ì—­ ëª¨ë‹¬ */
        .history-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; align-items: center; justify-content: center; }
        .history-modal.active { display: flex; }
        .history-content { background: white; width: 600px; max-width: 95%; max-height: 80vh; border-radius: 24px; overflow: hidden; display: flex; flex-direction: column; }
        .history-header { padding: 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
        .history-list { overflow-y: auto; padding: 0; margin: 0; flex: 1; }
        .history-item { display: flex; gap: 15px; padding: 15px 20px; border-bottom: 1px solid #f1f5f9; align-items: flex-start; }
        .h-time { font-size: 0.8em; color: #94a3b8; font-weight: 600; min-width: 60px; padding-top: 4px; }
        .h-info { flex: 1; }
        .h-title { font-weight: 700; color: #334155; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
        .h-msg { font-size: 0.95em; color: #64748b; line-height: 1.4; }
        
        /* ë¯¸ë””ì–´ ì¿¼ë¦¬ - í…Œì´ë¸” ë°˜ì‘í˜• */
        @media (max-width: 1400px) {
            .stock-table th, .stock-table td { padding: 10px 2px; font-size: 0.85em; }
            .container { padding: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-section">
            <div>
                <h1><span>ğŸ“Š</span> SM10 ì§€ëŠ¥í˜• ë§¤ë§¤ v18</h1>
                <div class="status-bar">
                    <span id="apiStatus" class="status-badge status-disconnected">â— API ì—°ê²°ì•ˆë¨</span>
                    <span id="syncStatus" class="status-badge status-disconnected">â— ë™ê¸°í™” ëŒ€ê¸°</span>
                </div>
            </div>
            <div class="top-controls">
                <button class="btn-ctrl btn-history" onclick="openHistoryModal()">
                    ğŸ“œ ì•Œë¦¼ë‚´ì—­ <span id="notiBadge" class="noti-count">0</span>
                </button>
                <button class="btn-ctrl" onclick="document.getElementById('alertModal').style.display='flex'">ğŸ”” ì„¤ì •</button>
                <button id="backupBtn" class="btn-ctrl btn-backup" onclick="manualBackup()" disabled>ğŸ’¾ ë°±ì—…</button>
                <button id="loadBtn" class="btn-ctrl btn-load" onclick="manualLoad()" disabled>ğŸ“¥ ë¡œë“œ</button>
                <button id="googleBtn" class="btn-ctrl btn-google" onclick="handleAuthClick()">ğŸ” êµ¬ê¸€ ë¡œê·¸ì¸</button>
            </div>
        </div>

        <div class="trading-guide">
            <span class="guide-icon">ğŸ“Œ</span>
            ë§¤ë§¤ ê¸°ì¤€: 3ê°œì›” ì‹ ê³ ê°€ | ë‹¹ì¼ê±°ë˜ëŒ€ê¸ˆ 500ì–µ ì´ìƒ (íš¡ë³´êµ¬ê°„ 300ì–µ) | í”„ë¡œê·¸ë¨ìˆœë§¤ë„ê°€ ê±°ë˜ëŒ€ê¸ˆ ëŒ€ë¹„ 10% ì´ìƒì¸ì§€ ì²´í¬
        </div>

        <div class="input-section">
            <div class="input-row">
                <div class="input-group input-record-high">
                    <label>ğŸš© ì‹ ê³ ê°€ (ë§¤ë§¤ì¢…ë£Œ ê¸°ì¤€)</label>
                    <input type="text" id="recordHighPrice" class="input-price" placeholder="ê°€ê²© ì…ë ¥">
                </div>
                <div class="input-group">
                    <label>ì°¨íŠ¸ êµ¬ë¶„</label>
                    <select id="stockType">
                        <option value="ì„¸ë ¥ì£¼">ì„¸ë ¥ì£¼ (ë³€ë™ì„± å¤§)</option>
                        <option value="ë°˜ìˆ˜ê¸‰ì£¼">ë°˜ìˆ˜ê¸‰ì£¼ (ì¤‘í˜•)</option>
                        <option value="ì´ˆëŒ€í˜•ì£¼">ì´ˆëŒ€í˜•ì£¼ (ì•ˆì •ì )</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>ì¢…ëª©ëª…</label>
                    <input type="text" id="stockName" placeholder="ì˜ˆ: ì‚¼ì„±ì „ì">
                </div>
                <div class="input-group">
                    <label>ì¢…ëª©ì½”ë“œ (6ìë¦¬)</label>
                    <input type="text" id="stockCode" maxlength="6" placeholder="ì˜ˆ: 005930">
                </div>
            </div>
            
            <div class="input-row">
                <div class="input-group">
                    <label>ê¸°ì¤€ê³ ê°€ (ë¹ˆì¹¸ì‹œ ëŠ¦ì€ë°œê²¬ ëª¨ë“œ)</label>
                    <input type="text" id="highPrice" class="input-price" placeholder="ì„ íƒì‚¬í•­ (ìŒë°”ë‹¥ ê³„ì‚°ìš©)">
                </div>
                <div class="input-group">
                    <label>ê¸°ì¤€ì €ê°€ (í•„ìˆ˜)</label>
                    <input type="text" id="lowPrice" class="input-price" placeholder="0">
                </div>
                <div class="input-group">
                    <label>ìˆ˜ì •ì €ê°€ (ì¸ì •ë°˜ë“±ì‹œ ìë™)</label>
                    <input type="text" id="adjustedLow" class="input-price" placeholder="ìë™ê³„ì‚°" style="background:#f0fdf4; border-color:#86efac;">
                </div>
                <div class="input-group">
                    <label>ë°˜ë“±ì €ê°€ (ë§¤ë„íƒ€ì ìš©)</label>
                    <input type="text" id="bouncePrice" class="input-price" placeholder="ì„ íƒì‚¬í•­">
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn-main btn-calc" onclick="calculate()">ğŸ’° ê³„ì‚°í•˜ê¸°</button>
                <button class="btn-main btn-add" onclick="addToList()">â• ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€</button>
                <button class="btn-main btn-reset" onclick="resetInput()">ğŸ”„ ì´ˆê¸°í™”</button>
            </div>
        </div>

        <div id="tempResults" style="display:none; background:white; padding:25px; border-radius:20px; border:2px solid #e2e8f0; margin-bottom:30px;">
            <h3 style="margin-bottom:20px; color:#475569;">ğŸ“ ê³„ì‚° ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:40px;">
                <div><h4 style="color:#dc2626; margin-bottom:10px;">ğŸ”´ ë§¤ìˆ˜ íƒ€ì </h4><div id="tempBuyPrices"></div></div>
                <div><h4 style="color:#2563eb; margin-bottom:10px;">ğŸ”µ ë§¤ë„ íƒ€ì </h4><div id="tempSellPrices"></div></div>
            </div>
        </div>

        <div class="stock-lists-container" id="stockListsWrapper"></div>
    </div>

    <div id="historyModal" class="history-modal">
        <div class="history-content">
            <div class="history-header">
                <h2>ğŸ“œ ë‹¹ì¼ ì•Œë¦¼ ë‚´ì—­</h2>
                <div style="display:flex; gap:10px;">
                    <button onclick="clearHistory()" style="padding:6px 12px; background:#f1f5f9; border:none; border-radius:8px; cursor:pointer; color:#64748b; font-weight:600;">ğŸ—‘ ê¸°ë¡ ì§€ìš°ê¸°</button>
                    <button onclick="document.getElementById('historyModal').classList.remove('active')" style="padding:6px 12px; background:#e2e8f0; border:none; border-radius:8px; cursor:pointer; font-weight:600;">ë‹«ê¸°</button>
                </div>
            </div>
            <div id="historyList" class="history-list"><div style="padding:40px; text-align:center; color:#94a3b8;">ì•„ì§ ë°œìƒí•œ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div></div>
        </div>
    </div>

    <div id="alertModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
        <div style="background:white; padding:30px; border-radius:20px; width:400px;">
            <h2 style="margin-bottom:20px;">ì•Œë¦¼ ì„¤ì •</h2>
            <div style="margin-bottom:15px;"><label><input type="checkbox" id="soundAlertToggle" checked> ì†Œë¦¬ ì•Œë¦¼ ì¼œê¸°</label></div>
            <div style="margin-bottom:20px;">
                <label>ê·¼ì ‘ ì•Œë¦¼ ë¯¼ê°ë„ (%)</label>
                <input type="number" id="alertThreshold" value="2.0" step="0.5" style="width:100%; margin-top:5px;" class="input-price">
            </div>
            <button onclick="document.getElementById('alertModal').style.display='none'" style="width:100%; padding:12px; background:#6366f1; color:white; border:none; border-radius:10px; cursor:pointer;">ì €ì¥ ë° ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        // ========== Google API ì„¤ì • ==========
        var CLIENT_ID = '574140412573-n0jau2i3uph1v5p3hi9v004m44bnopq8.apps.googleusercontent.com';
        var API_KEY = '';
        var DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        
        // [ìˆ˜ì •ë¨] ë“œë¼ì´ë¸Œ ì „ì²´ ì ‘ê·¼ ê¶Œí•œìœ¼ë¡œ ë³€ê²½ (ê¸°ì¡´ íŒŒì¼ ì¸ì‹ìš©)
        var SCOPES = 'https://www.googleapis.com/auth/drive';

        // ========== ì „ì—­ ì„¤ì • ==========
        var STORAGE_KEY = 'sm10_stock_lists_v16';
        var HISTORY_KEY = 'sm10_noti_history';
        var FILE_NAME = 'sm10_stocks_data.json'; 
        
        var stockLists = { 'ì„¸ë ¥ì£¼': [], 'ë°˜ìˆ˜ê¸‰ì£¼': [], 'ì´ˆëŒ€í˜•ì£¼': [] };
        var notificationHistory = [];
        var socket = null;
        var selectedIndex = -1;
        var selectedType = '';
        var unreadCount = 0;
        var tokenClient;
        var gapiInited = false;
        var gisInited = false;

        // ========== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ==========
        function formatInputPrice(e) {
            let val = e.target.value.replace(/[^0-9]/g, '');
            e.target.value = val.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        function parsePrice(str) { return parseFloat(str.replace(/,/g, '')) || 0; }
        function formatPrice(num) { return Math.round(num).toLocaleString('ko-KR'); }
        function getTickSize(price) {
            if (price < 2000) return 1; if (price < 5000) return 5; if (price < 20000) return 10;
            if (price < 50000) return 50; if (price < 200000) return 100; if (price < 500000) return 500; return 1000;
        }
        function adjustPrice(price, roundUp) {
            const unit = getTickSize(price);
            return roundUp ? Math.ceil(price/unit)*unit : Math.floor(price/unit)*unit;
        }

        // ========== ì•Œë¦¼ ë‚´ì—­ ê´€ë¦¬ ==========
        function addNotification(stockName, type, message) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            const noti = { id: Date.now(), time: timeStr, stockName: stockName, type: type, message: message };
            notificationHistory.unshift(noti);
            if (notificationHistory.length > 100) notificationHistory.pop();
            
            unreadCount++;
            updateBadge();
            
            const modal = document.getElementById('historyModal');
            if (modal.classList.contains('active')) renderHistoryList();
            sessionStorage.setItem(HISTORY_KEY, JSON.stringify(notificationHistory));
        }

        function renderHistoryList() {
            const listEl = document.getElementById('historyList');
            if (notificationHistory.length === 0) { listEl.innerHTML = '<div style="padding:40px; text-align:center; color:#94a3b8;">ì•„ì§ ë°œìƒí•œ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
            let html = '';
            notificationHistory.forEach(item => {
                html += `<div class="history-item"><div class="h-time">${item.time}</div><div class="h-info"><div class="h-title">${item.stockName}</div><div class="h-msg">${item.message}</div></div></div>`;
            });
            listEl.innerHTML = html;
        }
        function openHistoryModal() { document.getElementById('historyModal').classList.add('active'); renderHistoryList(); unreadCount = 0; updateBadge(); }
        function clearHistory() { if(confirm('ê¸°ë¡ì„ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) { notificationHistory = []; sessionStorage.removeItem(HISTORY_KEY); renderHistoryList(); } }
        function updateBadge() { const badge = document.getElementById('notiBadge'); if (unreadCount > 0) { badge.style.display = 'flex'; badge.innerText = unreadCount > 99 ? '99+' : unreadCount; } else { badge.style.display = 'none'; } }

        // ========== ê³„ì‚° ë¡œì§ ==========
        function calculatePoints(type, basePrice, bouncePrice) {
            let buyRatios, sellRatios;
            if (type === 'ì„¸ë ¥ì£¼') {
                buyRatios = [0.03, 0.06, 0.09, 0.12];
                sellRatios = [0.03, 0.04, 0.05, 0.06];
            } else if (type === 'ë°˜ìˆ˜ê¸‰ì£¼') {
                buyRatios = [0.025, 0.05, 0.075, 0.10];
                sellRatios = [0.025, 0.035, 0.045, 0.055];
            } else {
                buyRatios = [0.02, 0.04, 0.06, 0.08];
                sellRatios = [0.02, 0.03, 0.04, 0.05];
            }
            const buys = buyRatios.map(r => adjustPrice(basePrice * (1 - r), true));
            const sells = bouncePrice ? sellRatios.map(r => adjustPrice(bouncePrice * (1 + r), false)) : [];
            return { buys, sells };
        }

        // ========== UI ì œì–´ ==========
        function calculate() {
            const high = parsePrice(document.getElementById('highPrice').value);
            const low = parsePrice(document.getElementById('lowPrice').value);
            const adj = parsePrice(document.getElementById('adjustedLow').value);
            const bounce = parsePrice(document.getElementById('bouncePrice').value);
            const type = document.getElementById('stockType').value;
            
            if (!low) { showToast('âŒ ê¸°ì¤€ì €ê°€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            
            const base = adj || low;
            const { buys, sells } = calculatePoints(type, base, bounce);
            
            document.getElementById('tempResults').style.display = 'block';
            let buyHtml = '';
            buys.forEach((p, i) => { buyHtml += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>${i+1}ì°¨ ë§¤ìˆ˜</span><span class="price-buy">${formatPrice(p)}ì›</span></div>`; });
            document.getElementById('tempBuyPrices').innerHTML = buyHtml;
            let sellHtml = '';
            if (sells.length > 0) { sells.forEach((p, i) => { sellHtml += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>${i+1}ì°¨ ë§¤ë„</span><span class="price-sell">${formatPrice(p)}ì›</span></div>`; }); } 
            else { sellHtml = '<div style="text-align:center; color:#94a3b8; padding:10px;">ë°˜ë“±ì €ê°€ ì…ë ¥ ì‹œ í‘œì‹œë©ë‹ˆë‹¤</div>'; }
            document.getElementById('tempSellPrices').innerHTML = sellHtml;
        }

        function addToList() {
            const name = document.getElementById('stockName').value.trim();
            const code = document.getElementById('stockCode').value.trim();
            const type = document.getElementById('stockType').value;
            const recordHigh = parsePrice(document.getElementById('recordHighPrice').value);
            const high = parsePrice(document.getElementById('highPrice').value);
            const low = parsePrice(document.getElementById('lowPrice').value);
            const adj = parsePrice(document.getElementById('adjustedLow').value);
            const bounce = parsePrice(document.getElementById('bouncePrice').value);

            if (!name || !low) { showToast('âŒ ì¢…ëª©ëª…ê³¼ ê¸°ì¤€ì €ê°€ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.'); return; }

            const base = adj || low;
            const { buys, sells } = calculatePoints(type, base, bounce);

            const item = {
                id: Date.now(), name, code, type, recordHigh, high, low, adjusted: adj, bounce,
                buyPrices: buys, sellPrices: sells, doubleBottomPrice: 0,
                currentPrice: 0, changeRate: 0, lowestPrice: low, // ì´ˆê¸° ì €ì ì€ ê¸°ì¤€ì €ê°€ë¡œ ì„¤ì •
                isNewHigh: false, isUpdated: false, isDoubleBottom: false
            };

            // ìŒë°”ë‹¥ ê³„ì‚°
            if (high > 0 && low > 0) {
                const reboundPct = ((high - low) / low) * 100;
                let dbThreshold = 7.0;
                if (type === 'ë°˜ìˆ˜ê¸‰ì£¼') dbThreshold = 6.0;
                if (type === 'ì´ˆëŒ€í˜•ì£¼') dbThreshold = 4.0;

                if (reboundPct >= dbThreshold) {
                    item.isDoubleBottom = true;
                    item.doubleBottomPrice = adjustPrice(low * 1.01, true);
                    showToast(`âœ¨ ${name} ìŒë°”ë‹¥ íƒ€ì  ìƒì„±!`);
                }
            }

            const existingIdx = stockLists[type].findIndex(s => s.name === name);
            if (existingIdx >= 0) {
                if (confirm(`${name} ì¢…ëª© ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    if(stockLists[type][existingIdx].currentPrice > 0) {
                        item.currentPrice = stockLists[type][existingIdx].currentPrice;
                        item.changeRate = stockLists[type][existingIdx].changeRate;
                    }
                    item.lowestPrice = low; 
                    stockLists[type][existingIdx] = item;
                    showToast('âœ… ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                } else return;
            } else {
                stockLists[type].push(item);
                showToast('âœ… ë¦¬ìŠ¤íŠ¸ ì¶”ê°€ ì™„ë£Œ');
            }
            saveData(); renderAllLists(); resetInput();
            
            if (code && socket && socket.connected) { 
                registerRealtime(); 
            }
        }

        function renderAllLists() {
            const container = document.getElementById('stockListsWrapper');
            container.innerHTML = '';
            ['ì„¸ë ¥ì£¼', 'ë°˜ìˆ˜ê¸‰ì£¼', 'ì´ˆëŒ€í˜•ì£¼'].forEach(type => {
                const list = stockLists[type];
                const typeColor = type === 'ì„¸ë ¥ì£¼' ? '#fee2e2' : type === 'ë°˜ìˆ˜ê¸‰ì£¼' ? '#e0f2fe' : '#dcfce7';
                const typeTitleColor = type === 'ì„¸ë ¥ì£¼' ? '#991b1b' : type === 'ë°˜ìˆ˜ê¸‰ì£¼' ? '#075985' : '#166534';
                
                let criBadges = '';
                if(type === 'ì„¸ë ¥ì£¼') criBadges = `<div class="criteria-badges"><span class="cri-badge cri-blue">ê¸°ì¤€ 4%</span><span class="cri-badge cri-yellow">ì¸ì • 3%</span><span class="cri-badge cri-red">ìŒë°”ë‹¥ 7%</span></div>`;
                else if(type === 'ë°˜ìˆ˜ê¸‰ì£¼') criBadges = `<div class="criteria-badges"><span class="cri-badge cri-blue">ê¸°ì¤€ 3.5%</span><span class="cri-badge cri-yellow">ì¸ì • 3%</span><span class="cri-badge cri-red">ìŒë°”ë‹¥ 6%</span></div>`;
                else criBadges = `<div class="criteria-badges"><span class="cri-badge cri-blue">ê¸°ì¤€ 3%</span><span class="cri-badge cri-yellow">ì¸ì • 2.5%</span><span class="cri-badge cri-red">ìŒë°”ë‹¥ 4%</span></div>`;

                let html = `
                <div class="stock-list-box">
                    <div class="list-header" style="background:${typeColor}">
                        <div class="list-title" style="color:${typeTitleColor}">
                            ${type} ë¦¬ìŠ¤íŠ¸ <span style="font-size:0.8em; opacity:0.7">(${list.length})</span>
                        </div>
                        ${criBadges}
                    </div>
                    <table class="stock-table">
                        <thead>
                            <tr>
                                <th width="12%">ì¢…ëª©ì •ë³´</th><th width="8%">í˜„ì¬ê°€</th><th width="8%">ì‹ ê³ ê°€</th><th width="8%">ìŒë°”ë‹¥</th>
                                <th class="th-buy">1ì°¨ë§¤ìˆ˜</th><th class="th-buy">2ì°¨ë§¤ìˆ˜</th><th class="th-buy">3ì°¨ë§¤ìˆ˜</th><th class="th-buy">4ì°¨ë§¤ìˆ˜</th>
                                <th class="th-sell">1ì°¨ë§¤ë„</th><th class="th-sell">2ì°¨ë§¤ë„</th><th class="th-sell">3ì°¨ë§¤ë„</th><th class="th-sell">4ì°¨ë§¤ë„</th><th width="4%">ì‚­ì œ</th>
                            </tr>
                        </thead><tbody id="list-body-${type}">`;
                
                if (list.length === 0) { html += `<tr><td colspan="13" style="padding:30px; color:#94a3b8;">ë“±ë¡ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`; } 
                else {
                    list.forEach((item, idx) => {
                        html += createRowHTML(item, type, idx);
                    });
                }
                html += `</tbody></table></div>`; container.innerHTML += html;
            });
        }

        function createRowHTML(item, type, idx) {
            let priceDisplay = '-', rateDisplay = '';
            if (item.currentPrice > 0) {
                const rateClass = item.changeRate > 0 ? 'up' : item.changeRate < 0 ? 'down' : 'flat';
                const arrow = item.changeRate > 0 ? 'â–²' : item.changeRate < 0 ? 'â–¼' : '';
                priceDisplay = `<span id="price-val-${item.id}" class="price-current ${rateClass}">${formatPrice(item.currentPrice)}</span>`;
                rateDisplay = `<span id="rate-val-${item.id}" class="price-rate ${rateClass}">${arrow} ${item.changeRate.toFixed(2)}%</span>`;
            }
            
            let badges = '';
            if (item.isNewHigh) badges += `<span class="badge-n">N</span>`;
            if (item.isUpdated) badges += `<span class="badge-n badge-update">N</span>`;
            if (item.isDoubleBottom) badges += `<span class="badge-n badge-w">W</span>`;

            const buyTds = item.buyPrices.map(p => {
                let cls = 'price-buy';
                if(item.currentPrice > 0) {
                    const diff = item.currentPrice - p;
                    if(diff <= 0) return `<td><div class="prox-box prox-reached">${formatPrice(p)}</div></td>`;
                }
                return `<td class="${cls}">${formatPrice(p)}</td>`;
            }).join('');

            const sellTds = Array(4).fill(0).map((_, i) => {
                if(i < item.sellPrices.length) return `<td class="price-sell">${formatPrice(item.sellPrices[i])}</td>`;
                return `<td style="color:#cbd5e1">-</td>`;
            }).join('');

            const dbPrice = item.doubleBottomPrice ? `<span class="price-double">${formatPrice(item.doubleBottomPrice)}</span>` : '-';

            // [NEW] ë§¤ìˆ˜ ì¤€ë¹„ ìƒíƒœ í´ë˜ìŠ¤ ì ìš© ë¡œì§
            const effectiveLow = item.adjusted || item.low;
            let rowClass = '';
            if (item.currentPrice > 0 && item.currentPrice < effectiveLow) {
                rowClass = 'buy-ready';
            }

            return `
            <tr id="row-${item.id}" class="${rowClass}" onclick="loadItem('${type}', ${idx})">
                <td style="text-align:left;">
                    <div style="font-weight:700; font-size:1.05em;"><span id="name-${item.id}">${item.name}</span> <span id="badges-${item.id}">${badges}</span></div>
                    <div style="font-size:0.8em; color:#64748b;">${item.code}</div>
                </td>
                <td><div class="price-display">${priceDisplay}${rateDisplay}</div></td>
                <td style="color:#dc2626; font-weight:600;">${item.recordHigh ? formatPrice(item.recordHigh) : '-'}</td>
                <td id="db-${item.id}">${dbPrice}</td>
                ${buyTds}${sellTds}
                <td><button class="delete-btn" onclick="deleteItem('${type}', ${idx}, event)">Ã—</button></td>
            </tr>`;
        }

        function updateStockRow(item) {
            const row = document.getElementById(`row-${item.id}`);
            const priceVal = document.getElementById(`price-val-${item.id}`);
            const rateVal = document.getElementById(`rate-val-${item.id}`);
            const badges = document.getElementById(`badges-${item.id}`);
            const dbCell = document.getElementById(`db-${item.id}`);
            
            // [NEW] ë§¤ìˆ˜ ì¤€ë¹„ ìƒíƒœ ë™ì  ì—…ë°ì´íŠ¸
            if (row) {
                const effectiveLow = item.adjusted || item.low;
                if (item.currentPrice > 0 && item.currentPrice < effectiveLow) {
                    row.classList.add('buy-ready');
                } else {
                    row.classList.remove('buy-ready');
                }
            }

            if (priceVal && rateVal) {
                const rateClass = item.changeRate > 0 ? 'up' : item.changeRate < 0 ? 'down' : 'flat';
                const arrow = item.changeRate > 0 ? 'â–²' : item.changeRate < 0 ? 'â–¼' : '';
                priceVal.className = `price-current ${rateClass}`;
                priceVal.innerText = formatPrice(item.currentPrice);
                rateVal.className = `price-rate ${rateClass}`;
                rateVal.innerHTML = `${arrow} ${item.changeRate.toFixed(2)}%`;
            }

            if (badges) {
                let badgeHtml = '';
                if (item.isNewHigh) badgeHtml += `<span class="badge-n">N</span>`;
                if (item.isUpdated) badgeHtml += `<span class="badge-n badge-update">N</span>`;
                if (item.isDoubleBottom) badgeHtml += `<span class="badge-n badge-w">W</span>`;
                badges.innerHTML = badgeHtml;
            }

            if (dbCell && item.doubleBottomPrice) {
                dbCell.innerHTML = `<span class="price-double">${formatPrice(item.doubleBottomPrice)}</span>`;
            }
        }

        function loadItem(type, idx) {
            const item = stockLists[type][idx];
            selectedType = type; selectedIndex = idx;
            document.getElementById('stockType').value = item.type;
            document.getElementById('stockName').value = item.name;
            document.getElementById('stockCode').value = item.code;
            document.getElementById('recordHighPrice').value = item.recordHigh ? formatPrice(item.recordHigh) : '';
            document.getElementById('highPrice').value = item.high ? formatPrice(item.high) : '';
            document.getElementById('lowPrice').value = item.low ? formatPrice(item.low) : '';
            document.getElementById('adjustedLow').value = item.adjusted ? formatPrice(item.adjusted) : '';
            document.getElementById('bouncePrice').value = item.bounce ? formatPrice(item.bounce) : '';
            calculate(); 
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            if (item.isUpdated || item.isNewHigh) {
                item.isUpdated = false; item.isNewHigh = false; 
                saveData(); 
                const badges = document.getElementById(`badges-${item.id}`);
                if(badges) {
                    let badgeHtml = '';
                    if (item.isDoubleBottom) badgeHtml += `<span class="badge-n badge-w">W</span>`;
                    badges.innerHTML = badgeHtml;
                }
            }
        }

        function deleteItem(type, idx, event) {
            event.stopPropagation();
            if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                stockLists[type].splice(idx, 1);
                saveData(); renderAllLists(); registerRealtime();
            }
        }
        function resetInput() { document.querySelectorAll('input').forEach(el => el.value = ''); document.getElementById('tempResults').style.display = 'none'; selectedIndex = -1; }
        function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(stockLists)); }
        function loadData() { 
            const data = localStorage.getItem(STORAGE_KEY); 
            if (data) { stockLists = JSON.parse(data); renderAllLists(); }
            const history = sessionStorage.getItem(HISTORY_KEY);
            if (history) { notificationHistory = JSON.parse(history); }
        }

        function registerRealtime() {
            if (!socket || !socket.connected) return;
            const stocks = [];
            Object.values(stockLists).flat().forEach(s => { if (s.code) stocks.push({ code: s.code, name: s.name }); });
            socket.emit('register_stocks', { source: 'SM10', stocks });
        }

        function initSocket() {
            socket = io('http://localhost:5000');
            socket.on('connect', () => { document.getElementById('apiStatus').className = 'status-badge status-connected'; document.getElementById('apiStatus').innerText = 'â— API ì—°ê²°ë¨'; registerRealtime(); });
            socket.on('disconnect', () => { document.getElementById('apiStatus').className = 'status-badge status-disconnected'; document.getElementById('apiStatus').innerText = 'â— API ì—°ê²°ëŠê¹€'; });

            socket.on('realtime_update', (data) => {
                const { code, data: priceData } = data;
                let needSave = false;
                
                Object.keys(stockLists).forEach(type => {
                    stockLists[type].forEach(item => {
                        if (item.code === code) {
                            item.currentPrice = priceData.current_price;
                            item.changeRate = priceData.change_rate;
                            
                            if (item.recordHigh > 0 && item.currentPrice >= item.recordHigh && !item.isNewHigh) {
                                item.isNewHigh = true;
                                addNotification(item.name, 'high', `ì‹ ê³ ê°€(${formatPrice(item.recordHigh)}ì›) ëŒíŒŒ! ë§¤ë§¤ ì¢…ë£Œ ê³ ë ¤.`);
                                showToast(`ğŸ‰ ${item.name} ì‹ ê³ ê°€ ëŒíŒŒ!`);
                                needSave = true;
                            }

                            if (!item.lowestPrice || item.currentPrice < item.lowestPrice) { item.lowestPrice = item.currentPrice; }
                            
                            if (item.lowestPrice > 0) {
                                const reboundPct = ((item.currentPrice - item.lowestPrice) / item.lowestPrice) * 100;
                                let updateThreshold = 3.0;
                                let dbThreshold = 7.0;

                                if (type === 'ì„¸ë ¥ì£¼') { updateThreshold = 3.0; dbThreshold = 7.0; }
                                else if (type === 'ë°˜ìˆ˜ê¸‰ì£¼') { updateThreshold = 3.0; dbThreshold = 6.0; }
                                else if (type === 'ì´ˆëŒ€í˜•ì£¼') { updateThreshold = 2.5; dbThreshold = 4.0; }

                                if (reboundPct >= updateThreshold) {
                                    if (!item.adjusted || item.lowestPrice < item.adjusted) {
                                        item.adjusted = item.lowestPrice;
                                        const { buys } = calculatePoints(item.type, item.adjusted, item.bounce);
                                        item.buyPrices = buys;
                                        item.isUpdated = true;
                                        addNotification(item.name, 'update', `ì €ì (${formatPrice(item.lowestPrice)}ì›) ëŒ€ë¹„ ${reboundPct.toFixed(1)}% ë°˜ë“±. íƒ€ì  ì¬ì„¤ì •.`);
                                        showToast(`ğŸ”„ ${item.name} íƒ€ì  ê°±ì‹ `);
                                        needSave = true;
                                        renderAllLists();
                                        return; 
                                    }
                                }

                                if (reboundPct >= dbThreshold && !item.isDoubleBottom) {
                                    item.isDoubleBottom = true;
                                    item.doubleBottomPrice = adjustPrice(item.lowestPrice * 1.01, true);
                                    addNotification(item.name, 'reached', `ìŒë°”ë‹¥ ê¸°ì¤€(${dbThreshold}%) ì¶©ì¡±! íƒ€ì : ${formatPrice(item.doubleBottomPrice)}ì›`);
                                    showToast(`âœ¨ ${item.name} ìŒë°”ë‹¥ íƒ€ì  ìƒì„±!`);
                                    needSave = true;
                                }
                            }
                            updateStockRow(item);
                        }
                    });
                });
                if (needSave) saveData();
            });

            socket.on('price_alert', (data) => {
                let msgType = data.type === 'reached' ? 'reached' : 'alert';
                addNotification(data.name, msgType, `${data.status} (í˜„ì¬ê°€: ${formatPrice(data.current_price)}ì›)`);
                showToast(`ğŸ”” ${data.name} ${data.status}`);
            });
        }

        // ========== Google Drive & Session (ìˆ˜ì •ë¨) ==========
        function gapiLoaded() { gapi.load('client', initGapi); }
        async function initGapi() { 
            const config = { discoveryDocs: [DISCOVERY_DOC] }; if (API_KEY) config.apiKey = API_KEY; 
            await gapi.client.init(config); gapiInited = true; 
            restoreSession(); 
        }
        function gisLoaded() { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '' }); gisInited = true; }
        
        function handleAuthClick() { tokenClient.callback = async (resp) => { if (resp.error) throw resp; localStorage.setItem('google_token', resp.access_token); setLoggedInState(); await loadFromGoogleDrive(); }; tokenClient.requestAccessToken({ prompt: 'consent' }); }
        
        function setLoggedInState() {
            document.getElementById('syncStatus').className = 'status-badge status-connected'; 
            document.getElementById('syncStatus').innerText = 'â— êµ¬ê¸€ ì—°ë™ë¨'; 
            document.getElementById('backupBtn').disabled = false; 
            document.getElementById('loadBtn').disabled = false;
        }

        function restoreSession() {
            const token = localStorage.getItem('google_token');
            if (token) {
                gapi.client.setToken({ access_token: token });
                setLoggedInState();
                console.log('ğŸ”„ ì„¸ì…˜ ë³µêµ¬ë¨');
            }
        }

        // [ìˆ˜ì •ë¨] ì €ì¥ ë¡œì§ ê°•í™” (ì¤‘ë³µ íŒŒì¼ ë°©ì§€ ë° ëª…í™•í•œ ì—ëŸ¬ ì²˜ë¦¬)
        async function saveToGoogleDrive() {
            try {
                const content = JSON.stringify(stockLists, null, 2); 
                const fileId = await findFile();
                
                const blob = new Blob([content], { type: 'application/json' });
                const form = new FormData();
                const metadata = { name: FILE_NAME, mimeType: 'application/json' };
                
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', blob);

                const accessToken = localStorage.getItem('google_token');
                
                let url, method, actionMsg;
                if (fileId) {
                    // ìˆ˜ì • (PATCH)
                    url = `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`;
                    method = 'PATCH';
                    actionMsg = 'ìˆ˜ì •(Update)';
                    console.log(`[GoogleDrive] ê¸°ì¡´ íŒŒì¼ ID(${fileId})ì„ ì°¾ì•„ ë®ì–´ì”Œì›ë‹ˆë‹¤.`);
                } else {
                    // ì‹ ê·œ ìƒì„± (POST)
                    url = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';
                    method = 'POST';
                    actionMsg = 'ì‹ ê·œ ìƒì„±(Create)';
                    console.log(`[GoogleDrive] ê¸°ì¡´ íŒŒì¼ì´ ì—†ì–´ ìƒˆ íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.`);
                }

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Authorization': `Bearer ${accessToken}` },
                    body: form
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                }

                const result = await response.json();
                console.log('[GoogleDrive] ê²°ê³¼:', result);
                showToast(`â˜ï¸ êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë°±ì—… ì™„ë£Œ! (${actionMsg})`);
                
            } catch (e) {
                console.error('[GoogleDrive] ë°±ì—… ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', e);
                showToast(`âŒ ë°±ì—… ì‹¤íŒ¨: ${e.message}`);
                
                if (e.message.includes('403') || e.message.includes('401')) {
                    alert('ê¶Œí•œì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ë¶€ì¡±í•©ë‹ˆë‹¤. "êµ¬ê¸€ ë¡œê·¸ì¸" ë²„íŠ¼ì„ ë‹¤ì‹œ ëˆŒëŸ¬ ê¶Œí•œì„ ê°±ì‹ í•´ì£¼ì„¸ìš”.');
                }
            }
        }

        async function loadFromGoogleDrive() { try { const fileId = await findFile(); if (fileId) { const accessToken = localStorage.getItem('google_token'); const resp = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, { headers: { 'Authorization': `Bearer ${accessToken}` } }); const data = await resp.json(); stockLists = data; saveData(); renderAllLists(); showToast('ğŸ“¥ ë°ì´í„° ë¡œë“œ ì™„ë£Œ'); } else { showToast('âš ï¸ ë“œë¼ì´ë¸Œì— íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.'); } } catch (e) { console.error(e); showToast('âŒ ë¡œë“œ ì‹¤íŒ¨: ' + e.message); } }
        async function findFile() { const accessToken = localStorage.getItem('google_token'); const resp = await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${FILE_NAME}' and trashed=false`, { headers: { 'Authorization': `Bearer ${accessToken}` } }); const data = await resp.json(); return data.files?.[0]?.id; }
        function manualBackup() { if(confirm('êµ¬ê¸€ ë“œë¼ì´ë¸Œì— ë°±ì—…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) saveToGoogleDrive(); }
        function manualLoad() { if(confirm('êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?')) loadFromGoogleDrive(); }
        function showToast(msg) { const toast = document.createElement('div'); toast.className = 'toast'; toast.innerText = msg; document.body.appendChild(toast); setTimeout(() => toast.remove(), 3000); }

        window.onload = function() {
            loadData();
            document.querySelectorAll('.input-price').forEach(el => el.addEventListener('input', formatInputPrice));
            initSocket(); gapiLoaded(); gisLoaded();
        };
    </script>
</body>
</html>
